const selectCountryInput = $('[name="address[country]"]');
const selectStateInput = $('[name="address[state]"]');
const selectCityInput = $('[name="address[city]"]');
const selectPrimaryDocumentInput = $('[name="primary_document"]');
const selectPersonTypeInput = $('[name="type"]:checked');
const textZipInput = $('[name="address[zip]"]');
const textRegistryInput = $('[name="registry"]');
const textDocumentInput = $('[name="document"]');
const textContactInput = $('[name="contacts[value][]"]').not('[type="email"]');
const textBirthdateInput = $('[name="birthdate"]');

const inputMaskDate = '99/99/9999';
const inputMaskZip = '99.999-999';
const inputMaskRegistry = '99.999.999/9999-99';
const inputMaskDocument = '999.999.999-99';
const inputMaskContact = '(99) 999[9-]9999[9]';

selectCountryInput.change(onCountryChange);
selectPrimaryDocumentInput.change(onPrimaryDocumentChange);
selectPersonTypeInput.change(onPersonTypeChange);

textBirthdateInput.inputmask(inputMaskDate);

$(document).on('change', '[name="address[state]"]', onStateChange);

selectCountryInput.change(() => {
    let country = selectCountryInput.val();

    handleBrazilOnlyFields(country);
    handleRegistryMask(country);
    handleZipMask(country);
});

/**
 * Event called when person type change
 *
 * @return  {void}
 */
function onPersonTypeChange() {
    let notLegalFields = $('[not-legal]');
    let notFisicalFields = $('[not-fisical]');

    if (selectPersonTypeInput.val() == 'fisical') {
        notLegalFields.show();
        notFisicalFields.hide();
    } else {
        notLegalFields.hide();
        notFisicalFields.show();
    }

    onPrimaryDocumentChange(selectPersonTypeInput.val());
}

/**
 * Event called when primary document change
 *
 * @return  {void}
 */
function onPrimaryDocumentChange(personType) {
    let withIdentityFields = $('[data-identity-required]');
    let withPassportFields = $('[data-passport-required]');
    if (personType == 'legal') {
        withIdentityFields.hide();
        withPassportFields.hide();
        return;
    }

    if (selectPrimaryDocumentInput.val() == 'identity') {
        withIdentityFields.show();
        withPassportFields.hide();
    } else if (selectPrimaryDocumentInput.val() == 'passport') {
        withIdentityFields.hide();
        withPassportFields.show();
    } else {
        withIdentityFields.hide();
        withPassportFields.hide();
    }
}

/**
 * Event called when country change
 *
 * @param   {function}  callback
 * 
 * @return  {void}
 */
function onCountryChange(callback) {
    let country = selectCountryInput.val();

    handleBrazilOnlyFields(country);
    handleRegistryMask(country);
    handleZipMask(country);
    disableStateCity();
    fetchStates(country, callback);
}

/**
 * Event called when state change
 *
 * @param   {function}  callback
 *
 * @return  {void}
 */
function onStateChange(callback) {
    let country = selectCountryInput.val();
    let state = $('[name="address[state]"]').val();

    fetchCities(country, state, callback);
}

/**
 * Handle brazil-only fields display
 *
 * @param   {string}  country
 * 
 * @return  {void}
 */
function handleBrazilOnlyFields(country) {
    let brazilOnlyFields = $('[data-brazil-only]');

    if (isBrazil(country)) {
        brazilOnlyFields.show();
    } else {
        brazilOnlyFields.hide();
    }
}

/**
 * Handle contact country flag display
 *
 * @param   {string}  country
 *
 * @return  {void}
 */
function initContactCountryFlag() {
    let inputsLength = textContactInput.length;

    for (let i = 0; i < inputsLength; i++) {
        let iti = window.intlTelInput(textContactInput[i], {
            initialCountry: 'auto',
            separateDialCode: true,
            autoHideDialCode: false,
            preferredCountries: [
                'br',
                'de',
                'us',
            ]
        });

        let selectedCountry = iti.getSelectedCountryData().iso2;

        if (selectedCountry == 'br') {
            $(iti.a).inputmask(inputMaskContact);
        } else {
            $(iti.a).inputmask('remove');
            $(iti.a).val($(iti.a).val().replace(/\D/g, ''));
        }

        textContactInput[i].addEventListener('countrychange', () => {
            let selectedCountry = iti.getSelectedCountryData().iso2;

            if (selectedCountry == 'br') {
                $(iti.a).inputmask(inputMaskContact);
            } else {
                $(iti.a).inputmask('remove');
                $(iti.a).val($(iti.a).val().replace(/\D/g, ''));
            }
        });
    }
}

/**
 * Handle document input mask
 *
 * @return  {void}
 */
function handleDocumentMask() {
    textDocumentInput.inputmask(inputMaskDocument);
}

/**
 * Handle registry input mask
 *
 * @param   {string}  country
 *
 * @return  {void}
 */
function handleRegistryMask(country) {
    if (!isBrazil(country)) {
        textRegistryInput.inputmask('remove');
        if (textRegistryInput.val() !== undefined) {
            textRegistryInput.val(textRegistryInput.val().replace(/\D/g, ''));
        }
    } else {
        textRegistryInput.inputmask(inputMaskRegistry);
    }
}

/**
 * Handle zip input mask
 *
 * @param   {string}  country
 *
 * @return  {void}
 */
function handleZipMask(country) {
    if (!isBrazil(country)) {
        textZipInput.inputmask('remove');
        if (textZipInput.val() !== undefined) {
            textRegistryInput.val(textZipInput.val().replace(/\D/g, ''));
        }
    } else {
        textZipInput.inputmask(inputMaskZip);
    }
}

/**
 * Populate a select input with states
 *
 * @param   {object}  data
 *
 * @return  {void}
 */
function populateStateSelect(data) {
    let tag = '<select class="form-control" name="address[state]" disabled>';
    let region = '[data-state-region]';
    let select = $('[name="address[state]"]');

    select.remove();
    select = $(tag).appendTo(region);
    select.empty();

    select.append($('<option value>-- Selecione --</option>'));

    $(data).each((i, state) => {
        select.append($('<option>').attr('value', state.iso2).text(state.name));
    });

    // Reset and disable city
    $('[name="address[city]"]').val('');
    $('[name="address[city]"]').attr('disabled', true);

    select.removeAttr('disabled');
}

/**
 * Populate a select input with cities
 *
 * @param   {object}  data
 *
 * @return  {void}
 */
function populateCitySelect(data) {
    let tag = '<select class="form-control" name="address[city]" disabled>';
    let region = '[data-city-region]';
    let select = $('[name="address[city]"]');

    select.remove();
    select = $(tag).appendTo(region);
    select.empty();

    select.append($('<option value>-- Selecione --</option>'));

    $(data).each((i, city) => {
        select.append($('<option>').attr('value', city.id).text(city.name));
    });

    select.removeAttr('disabled');
}

/**
 * Create a text input to state
 *
 * @return  {void}
 */
function createStateInput() {
    let tag = '<input type="text" class="form-control text-uppercase" name="address[state]">';
    let region = '[data-state-region]';
    let input = $('[name="address[state]"]');

    input.remove();
    input = $(tag).appendTo(region);
}

/**
 * Create a text input to city
 *
 * @return  {void}
 */
function createCityInput() {
    let tag = '<input type="text" class="form-control text-uppercase" name="address[city]">';
    let region = '[data-city-region]';
    let input = $('[name="address[city]"]');

    input.remove();
    input = $(tag).appendTo(region);
}

/**
 * Fetch states calling API
 *
 * @param   {string}    country
 * @param   {function}  callback
 *
 * @return  {void}
 */
function fetchStates(country, callback) {
    $.get(`/api/countries/${country}/states`, (response) => {
        populateStateSelect(response);
    }).fail(() => {
        createStateInput();
        createCityInput();
    }).always(() => {
        if (callback && typeof callback === 'function') {
            callback();
        }
    });
}

/**
 * Fill preformed address fields
 *
 * @param   {object}  address
 *
 * @return  {void}
 */
function fillAddress(address) {
    onCountryChange(() => {
        $('[name="address[state]"').val(address.state);
        onStateChange(() => {
            $('[name="address[city]"').val(address.city);
        });
    });
}

/**
 * Disable state and city inputs
 *
 * @return  {void}
 */
function disableStateCity() {
    $('[name="address[state]"]').attr('disabled');
    $('[name="address[city]"]').attr('disabled');
}

/**
 * Check if country is Brazil
 *
 * @param   {string}  country
 * 
 * @return  {boolean}
 */
function isBrazil(country) {
    return country === 'BR';
}

/**
 * Check if input has input-mask
 *
 * @param   {object}  input
 * 
 * @return  {boolean}
 */
function hasMask(input) {
    return input.inputmask !== undefined && typeof input.inputmask !== 'function';
}

function catchFormSubmit(form) {
    form[0].addEventListener('submit', sanitizePhoneInputs);
}

function sanitizePhoneInputs(e) {
    let phoneInputs = $('.phone-flag');
    let length = phoneInputs.length;

    for (let i = 0; i < length; i++) {

        let input = $(phoneInputs[i]);
        let countryPrefix = input.parent().find('.iti__selected-dial-code').text();

        if (input.val()) {
            let value = input.val();
            value = value.replace(/\D/g, '');
            value = countryPrefix + '' + value;
            phoneInputs.inputmask('remove');
            input.val(value);
        }
    }
}

selectCountryInput.change(onCountryChange);

$(document).on('change', '[name="address[state]"]', onStateChange);

/**
 * Event called when country change
 *
 * @param   {function}  callback
 * 
 * @return  {void}
 */
function onCountryChange(callback) {
    let country = selectCountryInput.val();

    disableStateCity();
    fetchStates(country, callback);
}

/**
 * Event called when state change
 *
 * @param   {function}  callback
 *
 * @return  {void}
 */
function onStateChange(callback) {
    let country = selectCountryInput.val();
    let state = $('[name="address[state]"]').val();

    fetchCities(country, state, callback);
}

/**
 * Populate a select input with states
 *
 * @param   {object}  data
 *
 * @return  {void}
 */
function populateStateSelect(data) {
    let tag = '<select name="address[state]" id="sl-estado">';
    let region = '[data-state-region]';
    let select = $('[name="address[state]"]');

    select.remove();
    select = $(tag).appendTo(region);
    select.empty();

    select.append($('<option value>-- Selecione --</option>'));

    $(data).each((i, state) => {
        select.append($('<option>').attr('value', state.iso2).text(state.name));
    });

    // Reset and disable city
    $('[name="address[city]"]').val('');
    $('[name="address[city]"]').attr('disabled', true);

    select.removeAttr('disabled');
}

/**
 * Populate a select input with cities
 *
 * @param   {object}  data
 *
 * @return  {void}
 */
function populateCitySelect(data) {
    let tag = '<select class="form-control" name="address[city]" disabled>';
    let region = '[data-city-region]';
    let select = $('[name="address[city]"]');

    select.remove();
    select = $(tag).appendTo(region);
    select.empty();

    select.append($('<option value>-- Selecione --</option>'));

    $(data).each((i, city) => {
        select.append($('<option>').attr('value', city.id).text(city.name));
    });

    select.removeAttr('disabled');
}

/**
 * Create a text input to state
 *
 * @return  {void}
 */
function createStateInput() {
    let tag = '<input type="text" class="input-limpa" name="address[state]">';
    let region = '[data-state-region]';
    let input = $('[name="address[state]"]');

    input.remove();
    input = $(tag).appendTo(region);
}

/**
 * Create a text input to city
 *
 * @return  {void}
 */
function createCityInput() {
    let tag = '<input type="text" class="input-limpa" name="address[city]">';
    let region = '[data-city-region]';
    let input = $('[name="address[city]"]');

    input.remove();
    input = $(tag).appendTo(region);
}

/**
 * Fetch cities calling API
 *
 * @param   {string}    country
 * @param   {string}    state
 * @param   {function}  callback
 *
 * @return  {void}
 */
function fetchCities(country, state, callback) {
    $.get(`/api/countries/${country}/states/${state}/cities`, (response) => {
        populateCitySelect(response);
    }).fail(() => {
        createCityInput();
    }).always(() => {
        if (callback && typeof callback === 'function') {
            callback();
        }
    });
}

/**
 * Disable state and city inputs
 *
 * @return  {void}
 */
function disableStateCity() {
    $('[name="address[state]"]').attr('disabled');
    $('[name="address[city]"]').attr('disabled');
}

/**
 * Fill preformed address fields
 *
 * @param   {object}  address
 *
 * @return  {void}
 */
function fillAddress(address) {
    if (address.country) {
        onCountryChange(() => {
            $('[name="address[state]"').val(address.state);
            onStateChange(() => {
                $('[name="address[city]"').val(address.city);
            });
        });
    }
}

$(document).ready(() => {
    onPrimaryDocumentChange();
    handleDocumentMask();
    handleBrazilOnlyFields();
    onPersonTypeChange();
    initContactCountryFlag();
})